# System Guardian 技術架構文件

## 概述

System Guardian 是一個 AI 驅動的事件管理平台，旨在自主監控、分析並為值班事件提供解決方案建議。該平台與 Slack、GitHub、Jira、Datadog 及其他工具整合，提供即時洞察和 AI 驅動的補救建議。

## 技術架構

### 資料提取和處理流程

System Guardian 使用事件驅動的微服務架構從多個來源提取事件資料：

1. **多來源資料提取**
   - **GitHub 整合**：監控程式碼提交、問題和部署事件
   - **Jira 整合**：追蹤問題和評論
   - **Datadog 整合**：處理系統警報和監控資料
   - **技術文檔整合**：支援將技術文檔上傳至 Qdrant 向量資料庫作為 AI 解決方案生成的知識庫參考，提高 AI 解決方案的準確性和可靠性

2. **統一訊息規範**
   - 實現統一事件模型 (Event model)，將不同來源的資料轉換為標準格式
   - 使用 JSONB 資料類型保存完整原始事件內容，確保上下文完整性
   - 通過標準化的來源 (source)、事件類型 (event_type) 欄位實現跨平台事件分類
   - 內部訊息轉換層確保對外部事件的一致處理

3. **事件處理流程**
   - 使用 RabbitMQ 作為訊息佇列以確保事件處理可靠性
   - 事件消費服務 (EventConsumerService) 負責從佇列中提取和處理事件
   - 標準化事件資料並存儲在 PostgreSQL 資料庫中

4. **事件分析與回應機制**
   - 系統自動分析事件資料以識別潛在事件
   - 一旦事件確認，立即通過 Slack 機器人向相關團隊發送通知
   - 同時，自動創建 Jira 工單以追蹤解決進度
   - 基於事件上下文和歷史資料，立即生成初步解決建議 (Resolution)
   - 在整個流程中追蹤通知和回應狀態，以便後續優化

5. **資料標準化**
   - 將不同來源的資料轉換為統一的事件和事件模型
   - 建立事件與事件之間的關聯，構建完整的事件上下文

### AI 驅動的分析與洞察

1. **AI 引擎架構**
   - 核心 AIEngine 類提供向量嵌入、文本生成和相似性搜索功能
   - 支援多種 LLM 模型 (GPT-4o / GPT-4o mini)，可根據需求切換
   - 使用 OpenAI Embeddings API 生成向量表示

2. **向量資料庫**
   - 採用 Qdrant 向量資料庫高效存儲和檢索事件與知識嵌入
   - 提供高性能相似性搜索功能，用於找到相關事件和文檔

3. **AI 分析服務**
   - **事件檢測器 (IncidentDetector)**：自動識別潛在事件
   - **事件分析器 (IncidentAnalyzer)**：深入分析事件原因和影響
   - **嚴重性分類器 (SeverityClassifier)**：評估事件嚴重性
   - **相似性引擎 (IncidentSimilarity)**：識別相關歷史事件

4. **解決方案生成**
   - **解決方案生成器 (ResolutionGenerator)**：基於歷史資料、技術文檔和上下文生成補救建議
   - **知識檢索 (KnowledgeRetrieval)**：從向量資料庫查詢相關技術文檔片段作為解決方案生成的參考
   - **報告生成器 (ReportGenerator)**：自動生成事件報告和摘要，並參考相關技術文檔資訊

### API 端點和服務

System Guardian 提供一系列 REST API 端點，用於與其他系統整合：

1. **資料提取 API**
   - `/api/ingest/github`：接收 GitHub 事件
   - `/api/ingest/datadog`：處理 Datadog 警報
   - `/api/ingest/jira`：接收 Jira 事件
   - `/api/vector-db/knowledge/upload`：將技術文檔上傳至向量資料庫作為知識庫

2. **解決方案和事件管理 API**
   - `/api/ai/generate-resolution`：使用 AI 生成事件解決建議
   - `/api/ai/resolutions/{resolution_id}/apply`：標記解決方案為已應用
   - `/api/ai/resolutions/{resolution_id}/feedback`：提供解決方案反饋
   - `/api/ai/resolutions/incident/{incident_id}`：獲取特定事件的所有解決方案
   - `/api/ai/related-incidents`：找到相似的歷史事件並提供洞察

3. **報告和分析 API**
   - `/api/ai/generate-incident-report`：生成詳細事件報告
   - `/api/ai/generate-summary-report`：生成一段時間的摘要報告
   - `/api/ai/generate-recommendations`：基於事件歷史生成操作建議
   - `/api/ai/metrics`：獲取 AI 引擎性能指標

4. **高級分析 API**
   - `/api/ai/analytics/resolution-time/{time_range}`：分析解決時間統計
   - `/api/ai/analytics/common-failures`：識別常見故障模式
   - `/api/ai/analytics/ai-effectiveness`：評估 AI 建議有效性
   - `/api/ai/analytics/trend-report`：生成趨勢分析報告
   - `/api/ai/analytics/root-cause-analysis`：執行深度根本原因分析


## 資料模型

System Guardian 使用 SQLAlchemy ORM 定義以下核心模型：

1. **Incident**
   - 代表系統問題，包括標題、描述、嚴重性和狀態
   - 建立與觸發事件和相關事件的關聯

2. **Event**
   - 來自各種來源的事件資料
   - 包含來源、事件類型和完整事件內容
   - 統一事件模型確保對不同來源資料的一致處理

3. **Resolution**
   - AI 生成或手動提供的事件解決方案
   - 包含建議文本、置信度分數和使用者反饋

## 可擴展性和可靠性設計

1. **可擴展服務架構**
   - 微服務設計允許每個元件獨立擴展
   - 連接池配置優化確保高並發處理能力

2. **可靠性措施**
   - RabbitMQ 訊息佇列確保事件不丟失
   - 健全的錯誤處理和重試機制
   - 資料庫連接預檢和回收策略

3. **監控和日誌記錄**
   - 使用 Loguru 進行全面日誌記錄
   - AI 引擎性能指標追蹤
   - 資料庫查詢監控

## 技術決策、假設和權衡

1. **模型選擇考量**
   - **短期**：選擇 GPT-4o/GPT-4o mini 是因為它們強大的上下文理解能力和 API 可用性
   - **長期**：計劃評估在事件特定資料上微調的模型，以提高準確性並降低成本
   - **權衡**：在模型質量和推理成本之間取得平衡 - 關鍵事件使用 GPT-4o，常規案例使用 GPT-4o mini

2. **向量資料庫實現**
   - **決策**：選擇 Qdrant 是因為其輕量化架構與快速處理能力
   - **理由**：Qdrant 提供輕量級架構、快速響應時間和開源部署選項
   - **權衡**：為了提高查詢性能而接受增加的操作複雜性

3. **資料保留策略**
   - **短期**：存儲完整事件資料以提供全面上下文
   - **長期**：基於事件相關性實施智能資料歸檔
   - **假設**：完整事件資料對高質量 AI 解決方案生成至關重要
   - **權衡**：為了提高解決方案質量而增加存儲成本

4. **實際部署考量**
   - **假設**：API 速率限制可能會影響事件峰值期間的即時處理
   - **緩解措施**：為 LLM 請求實施優先級佇列和智能批處理
   - **權衡**：為確保系統穩定性而接受非關鍵事件的輕微延遲

## AI 效能測量

1. **解決方案質量指標**
   - **解決方案採用率**：工程師實施 AI 建議的百分比
   - **解決時間影響**：比較有無 AI 協助的解決時間
   - **反饋評分系統**：工程師對建議的相關性和適用性進行評分

2. **持續改進循環**
   - 工程師反饋直接影響未來相關事件的模型訓練和解決方案生成
   - 定期針對新的事件類型評估模型，以確保廣泛覆蓋
   - 定期分析性能指標，識別和解決改進機會

3. **效率測量**
   - 追蹤通過自動化解決方案建議節省的支援工程師時間
   - 衡量更好的文檔參考帶來的次要時間節省
   - 量化因事件持續時間減少和平均解決時間(MTTR)降低而產生的成本節省

## 結論

System Guardian 是一個全面的 AI 驅動事件管理平台，整合了多來源資料、AI 分析和解決方案生成。其事件驅動架構、統一訊息規範、向量搜索能力和先進的 LLM 整合使其能夠有效管理和解決值班事件，減少平均解決時間，提高運營效率。

該系統特別善於從歷史事件中學習，為當前事件提供相關的解決方案建議，並根據事件解決結果持續優化其建議質量。最重要的是，統一訊息規範的實施確保了在單一系統中一致處理和分析來自不同來源的資料，極大地提高了跨平台事件關聯和處理效率。

## 未來工作

System Guardian 團隊計劃以下功能增強，以進一步提升系統能力：

1. **解決方案置信度分數重新設計**
   - 目前的置信度分數計算機制存在不準確問題
   - 計劃重新設計算法，結合歷史成功率、上下文相似性和知識庫參考程度等多個指標
   - 引入機器學習模型，根據使用者反饋動態調整分數，實現持續優化

2. **智能聊天機器人**
   - 開發支援自然語言互動的聊天界面，允許使用者通過對話查詢和管理事件
   - 實現自動 SQL 查詢功能，使聊天機器人能夠根據使用者問題自動構建和執行資料庫查詢
   - 提供事件概覽、解決方案建議和歷史事件分析功能，減少操作複雜性
   - 支援跨平台整合，從 Slack 擴展到 Telegram 和 Discord 等通訊平台 